<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Electric Power System Analysis Dashboard</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Annotation Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@4.0.1"></script>
  <script>
    Chart.register(window['chartjs-plugin-annotation']);
  </script>
  <!-- MathJS -->
  <script src="https://cdn.jsdelivr.net/npm/mathjs@11.5.1/lib/browser/math.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .sidebar {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    }
    .power-factor-indicator {
      height: 10px;
      background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
    }
    .power-factor-marker {
      position: absolute;
      top: -5px;
      width: 2px;
      height: 20px;
      background-color: #000;
    }
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    .tab-active {
      border-bottom: 3px solid #3b82f6;
      color: #3b82f6;
      font-weight: 600;
    }
    .glow {
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
    }
    .result-card {
      transition: all 0.3s ease;
    }
    .result-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .footer {
            text-align: center;
            padding: 1rem;
            background: #333;
            color: white;
            position: fixed;
            width: 100%;
            bottom: 0;
   }
  </style>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
          <div class="flex items-center">
            <i class="fas fa-tint text-blue-500 text-3xl mr-3"></i>
            <h1 class="text-2xl font-bold text-gray-900">Electric Power System Analysis Dashboard</h1>
          </div>
          <div class="mt-4 md:mt-0">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
              <i class="fas fa-bolt mr-1"></i> <span class="italic"> Know your Power Consumption & Bill</span>
            </span>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
      <div class="flex flex-col lg:flex-row gap-6">
        <!-- Sidebar Input Section -->
        <div class="sidebar lg:w-1/3 p-6 rounded-xl text-white shadow-lg">
          <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fas fa-sliders-h mr-2"></i> Input Parameters
          </h2>
          
          <!-- System Type -->
          <div class="mb-6">
            <label class="block text-sm font-medium mb-1">System Type</label>
            <div class="flex rounded-md shadow-sm">
              <button id="single-phase-btn" class="flex-1 py-2 px-4 rounded-l-md bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <i class="fas fa-bolt mr-1"></i> Single Phase
              </button>
              <button id="three-phase-btn" class="flex-1 py-2 px-4 rounded-r-md bg-blue-800 hover:bg-blue-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <i class="fas fa-bolt mr-1"></i> Three Phase
              </button>
            </div>
          </div>
          
          <!-- Voltage Input -->
          <div class="mb-6">
            <label class="block text-sm font-medium mb-1">Source Voltage (kV)</label>
            <div class="relative rounded-md shadow-sm">
              <input type="number" id="voltage" value="0.23" min="0.1" step="0.01" class="w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-blue-500">
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                <span class="text-gray-900">kV</span>
              </div>
            </div>
            <p class="text-xs mt-1 text-blue-200">Single-phase RMS or 3φ line-to-line</p>
          </div>
          
          <!-- Device Management -->
          <div class="mb-6">
            <label class="block text-sm font-medium mb-1">Number of Devices</label>
            <div class="flex">
              <input type="number" id="num-devices" value="1" min="1" class="w-full p-2 rounded-l text-gray-900 focus:ring-2 focus:ring-blue-500">
              <button id="add-device-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded-r focus:outline-none focus:ring-2 focus:ring-blue-500">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
          
          <!-- Devices Container -->
          <div id="devices-container" class="mb-6 space-y-4">
            <!-- Device template will be inserted here -->
          </div>
          
          <!-- Power Factor Correction -->
          <div class="mb-6">
            <label class="block text-sm font-medium mb-1">Power Factor Correction</label>
            <select id="pf-correction-select" class="w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-blue-500">
              <option value="no">No Correction</option>
              <option value="yes">Apply Correction</option>
            </select>
          </div>
          
          <div id="pf-target-container" class="mb-6 hidden">
            <label class="block text-sm font-medium mb-1">Target Power Factor</label>
            <div class="flex items-center">
              <input type="range" id="pf-target" min="0.8" max="1" step="0.01" value="0.95" class="w-full mr-2">
              <span id="pf-target-value" class="text-sm font-medium">0.95</span>
            </div>
            <div class="power-factor-indicator mt-2 relative">
              <div id="pf-target-marker" class="power-factor-marker" style="left: 95%;"></div>
            </div>
          </div>
          
          <!-- Economic Parameters -->
          <div class="mb-6">
            <label class="block text-sm font-medium mb-1">Economic Parameters</label>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs mb-1">Utility Rate ($/kWh)</label>
                <input type="number" id="utility-rate" value="0.12" min="0" step="0.01" class="w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-xs mb-1">Reactive Charge ($/kVArh)</label>
                <input type="number" id="reactive-rate" value="0.05" min="0" step="0.01" class="w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-xs mb-1">Hours/Day</label>
                <input type="number" id="operating-hours" value="8" min="0" step="0.1" class="w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-xs mb-1">Days/Month</label>
                <input type="number" id="operating-days" value="30" min="0" step="1" class="w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
          </div>
          
          <!-- Calculate Button -->
          <button id="calculate-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
            <i class="fas fa-calculator mr-2"></i> Calculate Power Parameters
          </button>
          
          <!-- Test Button -->
          <div class="mt-4">
            <button id="test-btn" class="w-full bg-gray-700 hover:bg-gray-800 text-white py-2 px-4 rounded-lg text-sm flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-gray-500">
              <i class="fas fa-vial mr-2"></i> Run Validation Tests
            </button>
          </div>
        </div>
        
        <!-- Results Section -->
        <div class="lg:w-2/3 bg-white rounded-xl shadow-lg overflow-hidden">
          <!-- Results Header -->
          <div class="bg-gray-50 px-6 py-4 border-b">
            <h2 class="text-xl font-semibold text-gray-800 flex items-center">
              <i class="fas fa-chart-bar text-blue-500 mr-2"></i> Analysis Results
            </h2>
          </div>
          
          <!-- Error Display -->
          <div id="error-display" class="hidden bg-red-50 border-l-4 border-red-500 p-4 m-4">
            <div class="flex">
              <div class="flex-shrink-0">
                <i class="fas fa-exclamation-circle text-red-500"></i>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800" id="error-message"></h3>
              </div>
            </div>
          </div>
          
          <!-- Results Tabs -->
          <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8 px-6">
              <button id="summary-tab" class="tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                <i class="fas fa-list-ul mr-1"></i> Summary
              </button>
              <button id="devices-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                <i class="fas fa-microchip mr-1"></i> Devices
              </button>
              <button id="correction-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                <i class="fas fa-adjust mr-1"></i> PF Correction
              </button>
              <button id="economics-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                <i class="fas fa-dollar-sign mr-1"></i> Economics
              </button>
            </nav>
          </div>
          
          <!-- Tab Contents -->
          <div class="p-6">
            <!-- Summary Tab Content -->
            <div id="summary-content" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="result-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                  <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-3">
                      <i class="fas fa-bolt text-xl"></i>
                    </div>
                    <div>
                      <p class="text-sm font-medium text-gray-500">Total Real Power</p>
                      <p id="total-p" class="text-2xl font-semibold text-gray-800">0 kW</p>
                    </div>
                  </div>
                </div>
                <div class="result-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                  <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600 mr-3">
                      <i class="fas fa-wave-square text-xl"></i>
                    </div>
                    <div>
                      <p class="text-sm font-medium text-gray-500">Total Reactive Power</p>
                      <p id="total-q" class="text-2xl font-semibold text-gray-800">0 kVAr</p>
                    </div>
                  </div>
                </div>
                <div class="result-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                  <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600 mr-3">
                      <i class="fas fa-chart-pie text-xl"></i>
                    </div>
                    <div>
                      <p class="text-sm font-medium text-gray-500">Total Apparent Power</p>
                      <p id="total-s" class="text-2xl font-semibold text-gray-800">0 kVA</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="result-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                  <div class="flex items-center mb-4">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 mr-3">
                      <i class="fas fa-percentage text-xl"></i>
                    </div>
                    <div>
                      <p class="text-sm font-medium text-gray-500">Power Factor</p>
                      <p id="total-pf" class="text-2xl font-semibold text-gray-800">0.00</p>
                    </div>
                  </div>
                  <div class="power-factor-indicator relative">
                    <div id="current-pf-marker" class="power-factor-marker" style="left: 0%;"></div>
                  </div>
                  <div class="flex justify-between text-xs mt-1">
                    <span>0.0</span>
                    <span>0.5</span>
                    <span>1.0</span>
                  </div>
                </div>
                
                <div class="result-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                  <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600 mr-3">
                      <i class="fas fa-plug text-xl"></i>
                    </div>
                    <div>
                      <p class="text-sm font-medium text-gray-500">Total Current</p>
                      <p id="total-current" class="text-2xl font-semibold text-gray-800">0 A</p>
                    </div>
                  </div>
                  <div class="mt-4">
                    <p class="text-sm font-medium text-gray-500">Equivalent Impedance</p>
                    <p id="total-z" class="text-xl font-semibold text-gray-800">0 Ω</p>
                  </div>
                </div>
              </div>
              
              <div class="chart-container">
                <canvas id="power-triangle-chart"></canvas>
              </div>
            </div>
            
            <!-- Devices Tab Content -->
            <div id="devices-content" class="hidden">
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Device</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P (kW)</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Q (kVAr)</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">S (kVA)</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PF</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">I (A)</th>
                    </tr>
                  </thead>
                  <tbody id="devices-results-body" class="bg-white divide-y divide-gray-200">
                    <!-- Device results will be inserted here -->
                  </tbody>
                </table>
              </div>
              <div class="mt-4 flex justify-end">
                <button id="download-csv" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                  <i class="fas fa-download mr-2"></i> Download CSV
                </button>
              </div>
            </div>
            
            <!-- Correction Tab Content -->
            <div id="correction-content" class="hidden">
              <div id="no-correction-needed" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                <div class="flex">
                  <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-yellow-400"></i>
                  </div>
                  <div class="ml-3">
                    <p class="text-sm text-yellow-700">Power factor correction not needed — already meets target.</p>
                  </div>
                </div>
              </div>
              
              <div id="correction-results" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Correction Parameters</h3>
                    <div class="space-y-4">
                      <div>
                        <p class="text-sm font-medium text-gray-500">Required Capacitive kVAr</p>
                        <p id="qc-needed" class="text-xl font-semibold text-gray-800">0 kVAr</p>
                      </div>
                      <div>
                        <p class="text-sm font-medium text-gray-500">Capacitive Reactance (Xc)</p>
                        <p id="xc-ohm" class="text-xl font-semibold text-gray-800">0 Ω</p>
                      </div>
                      <div>
                        <p class="text-sm font-medium text-gray-500">Total Capacitance</p>
                        <p id="c-total" class="text-xl font-semibold text-gray-800">0 F</p>
                      </div>
                      <div id="per-phase-container" class="hidden">
                        <p class="text-sm font-medium text-gray-500">Per-Phase Capacitance (Wye)</p>
                        <p id="c-per-phase" class="text-xl font-semibold text-gray-800">0 F</p>
                      </div>
                    </div>
                  </div>
                  
                  <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Corrected Values</h3>
                    <div class="space-y-4">
                      <div>
                        <p class="text-sm font-medium text-gray-500">Corrected Power Factor</p>
                        <p id="corrected-pf" class="text-xl font-semibold text-gray-800">0.00</p>
                      </div>
                      <div>
                        <p class="text-sm font-medium text-gray-500">Corrected Reactive Power</p>
                        <p id="corrected-q" class="text-xl font-semibold text-gray-800">0 kVAr</p>
                      </div>
                      <div>
                        <p class="text-sm font-medium text-gray-500">Corrected Apparent Power</p>
                        <p id="corrected-s" class="text-xl font-semibold text-gray-800">0 kVA</p>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div class="chart-container">
                    <canvas id="before-correction-chart"></canvas>
                  </div>
                  <div class="chart-container">
                    <canvas id="after-correction-chart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Economics Tab Content -->
            <div id="economics-content" class="hidden">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <h3 class="text-lg font-medium text-gray-900 mb-4">Current Costs</h3>
                  <div class="space-y-4">
                    <div>
                      <p class="text-sm font-medium text-gray-500">Energy Consumption</p>
                      <p id="energy-consumption" class="text-xl font-semibold text-gray-800">0 kWh/month</p>
                    </div>
                    <div>
                      <p class="text-sm font-medium text-gray-500">Energy Cost</p>
                      <p id="energy-cost" class="text-xl font-semibold text-gray-800">$0/month</p>
                    </div>
                    <div>
                      <p class="text-sm font-medium text-gray-500">Reactive Energy</p>
                      <p id="reactive-energy" class="text-xl font-semibold text-gray-800">0 kVArh/month</p>
                    </div>
                    <div>
                      <p class="text-sm font-medium text-gray-500">Reactive Cost</p>
                      <p id="reactive-cost" class="text-xl font-semibold text-gray-800">$0/month</p>
                    </div>
                  </div>
                </div>
                
                <div id="savings-container" class="hidden">
                  <h3 class="text-lg font-medium text-gray-900 mb-4">Potential Savings</h3>
                  <div class="space-y-4">
                    <div>
                      <p class="text-sm font-medium text-gray-500">Corrected Reactive Cost</p>
                      <p id="corrected-reactive-cost" class="text-xl font-semibold text-gray-800">$0/month</p>
                    </div>
                    <div>
                      <p class="text-sm font-medium text-gray-500">Energy Loss Savings</p>
                      <p id="energy-savings" class="text-xl font-semibold text-gray-800">$0/month</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                      <p class="text-sm font-medium text-gray-500">Total Potential Savings</p>
                      <p id="total-savings" class="text-2xl font-bold text-blue-800">$0/month</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div id="no-savings" class="mt-6 bg-blue-50 border-l-4 border-blue-400 p-4">
                <div class="flex">
                  <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-400"></i>
                  </div>
                  <div class="ml-3">
                    <p class="text-sm text-blue-700">Apply power factor correction to see potential savings.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Utility functions
    const sanitizePf = (pf) => {
      if (pf === null || pf === undefined || isNaN(pf)) return null;
      return Math.max(0, Math.min(1, pf));
    };

    const pfToDeg = (pf) => {
      const c = Math.min(1, Math.max(0, pf || 0));
      return Math.acos(c) * (180 / Math.PI);
    };

    const toNum = (v) => (typeof v === 'number' && !isNaN(v) ? v : 0);

    // Core calculations
    const calculatePowerParameters = (V_kV, params, systemType) => {
      const { P = null, S = null, pf = null, Q = null, I = null } = params;
      const V = V_kV * 1000; // volts
      const pf_s = sanitizePf(pf);

      let Z_eq, phiDeg, S_VA, P_W, Q_var, pf_calc, I_A;

      const radToDeg = (r) => r * (180 / Math.PI);

      if (systemType === 'Single') {
        if (P !== null && pf_s !== null && !isNaN(P) && !isNaN(pf_s)) {
          P_W = P * 1000;
          S_VA = P_W / pf_s;
          Q_var = Math.sqrt(Math.max(S_VA**2 - P_W**2, 0));
          pf_calc = pf_s;
          phiDeg = radToDeg(Math.acos(pf_calc));
        } else if (S !== null && pf_s !== null) {
          S_VA = S * 1000;
          P_W = S_VA * pf_s;
          Q_var = Math.sqrt(Math.max(S_VA**2 - P_W**2, 0));
          pf_calc = pf_s;
          phiDeg = radToDeg(Math.acos(pf_calc));
        } else if (P !== null && I !== null) {
          P_W = P * 1000;
          S_VA = V * I;
          pf_calc = S_VA !== 0 ? P_W / S_VA : 0;
          Q_var = Math.sqrt(Math.max(S_VA**2 - P_W**2, 0));
          phiDeg = pf_calc > 0 ? radToDeg(Math.acos(Math.min(1, Math.max(0, pf_calc)))) : 0;
        } else if (P !== null && Q !== null) {
          P_W = P * 1000;
          Q_var = Q * 1000;
          S_VA = Math.sqrt(P_W**2 + Q_var**2);
          pf_calc = S_VA !== 0 ? P_W / S_VA : 0;
          phiDeg = pf_calc > 0 ? radToDeg(Math.acos(Math.min(1, Math.max(0, pf_calc)))) : 0;
        } else {
          throw new Error('Insufficient parameters provided.');
        }
        if (!S_VA || S_VA === 0) throw new Error('Apparent power (S) cannot be zero or null.');
        Z_eq = V**2 / S_VA; // effective V^2/S
        I_A = S_VA / V;
      } else if (systemType === 'Three') {
        if (P !== null && pf_s !== null) {
          P_W = P * 1000;
          S_VA = P_W / pf_s;
          Q_var = Math.sqrt(Math.max(S_VA**2 - P_W**2, 0));
          pf_calc = pf_s;
          phiDeg = radToDeg(Math.acos(pf_calc));
        } else if (S !== null && pf_s !== null) {
          S_VA = S * 1000;
          P_W = S_VA * pf_s;
          Q_var = Math.sqrt(Math.max(S_VA**2 - P_W**2, 0));
          pf_calc = pf_s;
          phiDeg = radToDeg(Math.acos(pf_calc));
        } else if (P !== null && I !== null) {
          P_W = P * 1000;
          S_VA = Math.sqrt(3) * V * I;
          pf_calc = S_VA !== 0 ? P_W / S_VA : 0;
          Q_var = Math.sqrt(Math.max(S_VA**2 - P_W**2, 0));
          phiDeg = pf_calc > 0 ? radToDeg(Math.acos(Math.min(1, Math.max(0, pf_calc)))) : 0;
        } else if (P !== null && Q !== null) {
          P_W = P * 1000;
          Q_var = Q * 1000;
          S_VA = Math.sqrt(P_W**2 + Q_var**2);
          pf_calc = S_VA !== 0 ? P_W / S_VA : 0;
          phiDeg = pf_calc > 0 ? radToDeg(Math.acos(Math.min(1, Math.max(0, pf_calc)))) : 0;
        } else {
          throw new Error('Insufficient parameters provided.');
        }
        if (!S_VA || S_VA === 0) throw new Error('Apparent power (S) cannot be zero or null.');
        Z_eq = V**2 / S_VA; // system equivalent
        I_A = S_VA / (Math.sqrt(3) * V);
      } else {
        throw new Error("Invalid system type. Choose 'Single' or 'Three'.");
      }

      return {
        Z: Z_eq,
        I: I_A ?? I,
        phiDeg,
        S: S_VA,
        P: P_W,
        Q: Q_var,
        pf: pf_calc
      };
    };

    const calculateCorrection = (totalP_kW, totalQ_kVAr, totalS_kVA, totalPf, pfTarget, systemType, voltage, utilityRate, reactiveChargeRate, operatingHours, operatingDays) => {
      if (pfTarget === null) return null;
      const pf1 = totalPf;
      const pf2 = sanitizePf(pfTarget);
      if (pf2 === null) return null;
      if (pf1 >= pf2) return null;

      // Qc (kVAr) needed
      const QcNeeded_kVAr = totalP_kW * (Math.tan(Math.acos(pf1)) - Math.tan(Math.acos(pf2)));
      const Qc_VAr = QcNeeded_kVAr * 1000; // in VAr

      const V = voltage * 1000; // Volts (LL for 3-ph)
      const f = 60; // Hz
      const omega = 2 * Math.PI * f;

      // Using Q = V^2 * omega * C  (for 1-φ and 3-φ wye total bank with LL voltage)
      const C_total_F = Qc_VAr / (omega * V * V);
      const Xc_ohm = C_total_F > 0 ? 1 / (omega * C_total_F) : Infinity;

      // Corrected system values
      const correctedQ_kVAr = Math.max(totalQ_kVAr - QcNeeded_kVAr, 0);
      const correctedS_kVA = Math.sqrt(totalP_kW**2 + correctedQ_kVAr**2);
      const correctedPf = correctedS_kVA > 0 ? totalP_kW / correctedS_kVA : 1;

      // Costs
      const reactiveEnergy_before = totalQ_kVAr * operatingHours * operatingDays; // kVArh per month
      const reactiveEnergy_after  = correctedQ_kVAr * operatingHours * operatingDays; // kVArh
      const reactiveCost_before = reactiveEnergy_before * reactiveChargeRate;
      const reactiveCost_after  = reactiveEnergy_after  * reactiveChargeRate;

      // Heuristic: assume copper losses ~ I^2 ~ (S/V)^2; approximate savings via pf improvement
      const lossReductionPct = pf1 > 0 ? Math.max(0, 1 - (correctedPf / pf1)) : 0;
      const energyCost_before = totalP_kW * operatingHours * operatingDays * utilityRate;
      const energyLossSavings = energyCost_before * lossReductionPct;
      const totalSavings = Math.max(reactiveCost_before - reactiveCost_after + energyLossSavings, 0);

      // For 3-φ, also show per-phase suggestion (wye)
      const perPhase_F = systemType === 'Three' ? C_total_F / 3 : C_total_F;

      return {
        QcNeeded_kVAr,
        Xc_ohm,
        C_total_F,
        perPhase_F,
        correctedQ_kVAr,
        correctedS_kVA,
        correctedPf,
        reactiveCost_after,
        energyLossSavings,
        totalSavings
      };
    };

    // DOM Elements
    const elements = {
      systemType: 'Single',
      voltage: document.getElementById('voltage'),
      numDevices: document.getElementById('num-devices'),
      addDeviceBtn: document.getElementById('add-device-btn'),
      devicesContainer: document.getElementById('devices-container'),
      pfCorrectionSelect: document.getElementById('pf-correction-select'),
      pfTargetContainer: document.getElementById('pf-target-container'),
      pfTarget: document.getElementById('pf-target'),
      pfTargetValue: document.getElementById('pf-target-value'),
      pfTargetMarker: document.getElementById('pf-target-marker'),
      utilityRate: document.getElementById('utility-rate'),
      reactiveRate: document.getElementById('reactive-rate'),
      operatingHours: document.getElementById('operating-hours'),
      operatingDays: document.getElementById('operating-days'),
      calculateBtn: document.getElementById('calculate-btn'),
      testBtn: document.getElementById('test-btn'),
      singlePhaseBtn: document.getElementById('single-phase-btn'),
      threePhaseBtn: document.getElementById('three-phase-btn'),
      
      // Results elements
      errorDisplay: document.getElementById('error-display'),
      errorMessage: document.getElementById('error-message'),
      
      // Summary tab
      totalP: document.getElementById('total-p'),
      totalQ: document.getElementById('total-q'),
      totalS: document.getElementById('total-s'),
      totalPf: document.getElementById('total-pf'),
      totalCurrent: document.getElementById('total-current'),
      totalZ: document.getElementById('total-z'),
      currentPfMarker: document.getElementById('current-pf-marker'),
      powerTriangleChart: document.getElementById('power-triangle-chart'),
      
      // Devices tab
      devicesResultsBody: document.getElementById('devices-results-body'),
      downloadCsv: document.getElementById('download-csv'),
      
      // Correction tab
      noCorrectionNeeded: document.getElementById('no-correction-needed'),
      correctionResults: document.getElementById('correction-results'),
      qcNeeded: document.getElementById('qc-needed'),
      xcOhm: document.getElementById('xc-ohm'),
      cTotal: document.getElementById('c-total'),
      perPhaseContainer: document.getElementById('per-phase-container'),
      cPerPhase: document.getElementById('c-per-phase'),
      correctedPf: document.getElementById('corrected-pf'),
      correctedQ: document.getElementById('corrected-q'),
      correctedS: document.getElementById('corrected-s'),
      beforeCorrectionChart: document.getElementById('before-correction-chart'),
      afterCorrectionChart: document.getElementById('after-correction-chart'),
      
      // Economics tab
      energyConsumption: document.getElementById('energy-consumption'),
      energyCost: document.getElementById('energy-cost'),
      reactiveEnergy: document.getElementById('reactive-energy'),
      reactiveCost: document.getElementById('reactive-cost'),
      savingsContainer: document.getElementById('savings-container'),
      correctedReactiveCost: document.getElementById('corrected-reactive-cost'),
      energySavings: document.getElementById('energy-savings'),
      totalSavings: document.getElementById('total-savings'),
      noSavings: document.getElementById('no-savings'),
      
      // Tabs
      summaryTab: document.getElementById('summary-tab'),
      devicesTab: document.getElementById('devices-tab'),
      correctionTab: document.getElementById('correction-tab'),
      economicsTab: document.getElementById('economics-tab'),
      summaryContent: document.getElementById('summary-content'),
      devicesContent: document.getElementById('devices-content'),
      correctionContent: document.getElementById('correction-content'),
      economicsContent: document.getElementById('economics-content')
    };

    // Device template
    const deviceTemplate = (index) => `
      <div class="device bg-blue-900 bg-opacity-20 p-4 rounded-lg" data-index="${index}">
        <div class="flex justify-between items-center mb-2">
          <h3 class="font-medium">Device ${index + 1}</h3>
          <button class="remove-device text-red-400 hover:text-red-300 text-sm" data-index="${index}">
            <i class="fas fa-times"></i> Remove
          </button>
        </div>
        
        <div class="mb-3">
          <label class="block text-sm font-medium mb-1">Equipment Type</label>
          <select class="equipment-type w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-blue-500">
            <option value="Motor">Motor</option>
            <option value="Pump">Pump</option>
            <option value="General Units">General Units</option>
            <option value="HVAC">HVAC</option>
            <option value="Transformer">Transformer</option>
          </select>
        </div>
        
        <div class="mb-3">
          <label class="block text-sm font-medium mb-1">Load Type</label>
          <select class="load-type w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-blue-500">
            <option value="S & pf">S & pf</option>
            <option value="P & pf">P & pf</option>
            <option value="P+jQ">P+jQ</option>
            <option value="P & I">P & I</option>
          </select>
        </div>
        
        <div class="load-parameters grid gap-3">
          <!-- Parameters will be inserted based on load type -->
        </div>
      </div>
    `;

    // Load type parameter templates
    const loadTypeTemplates = {
      'S & pf': `
        <div>
          <label class="block text-sm font-medium mb-1">Apparent Power (kVA)</label>
          <input type="number" class="s-value w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-blue-500" min="0" step="0.1">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Power Factor (0 < pf ≤ 1)</label>
          <input type="number" class="pf-value w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-blue-500" min="0" max="1" step="0.01" value="0.9">
        </div>
      `,
      'P & pf': `
        <div>
          <label class="block text-sm font-medium mb-1">Real Power (kW)</label>
          <input type="number" class="p-value w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-blue-500" min="0" step="0.1">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Power Factor (0 < pf ≤ 1)</label>
          <input type="number" class="pf-value w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-blue-500" min="0" max="1" step="0.01" value="0.9">
        </div>
      `,
      'P+jQ': `
        <div>
          <label class="block text-sm font-medium mb-1">Real Power (kW)</label>
          <input type="number" class="p-value w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-blue-500" min="0" step="0.1">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Reactive Power (kVAr)</label>
          <input type="number" class="q-value w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-blue-500" min="0" step="0.1">
        </div>
      `,
      'P & I': `
        <div>
          <label class="block text-sm font-medium mb-1">Real Power (kW)</label>
          <input type="number" class="p-value w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-blue-500" min="0" step="0.1">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Current (A)</label>
          <input type="number" class="i-value w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-blue-500" min="0" step="0.1">
        </div>
      `
    };

    // Initialize the first device
    const initializeDevices = () => {
      elements.devicesContainer.innerHTML = '';
      const numDevices = parseInt(elements.numDevices.value) || 1;
      
      for (let i = 0; i < numDevices; i++) {
        addDevice(i);
      }
    };

    // Add a new device
    const addDevice = (index) => {
      const deviceElement = document.createElement('div');
      deviceElement.innerHTML = deviceTemplate(index);
      elements.devicesContainer.appendChild(deviceElement);
      
      // Set up load type parameters
      const deviceDiv = elements.devicesContainer.querySelector(`.device[data-index="${index}"]`);
      const loadTypeSelect = deviceDiv.querySelector('.load-type');
      const loadParamsDiv = deviceDiv.querySelector('.load-parameters');
      
      loadParamsDiv.innerHTML = loadTypeTemplates['P & pf'];
      
      // Add event listener for load type change
      loadTypeSelect.addEventListener('change', (e) => {
        loadParamsDiv.innerHTML = loadTypeTemplates[e.target.value];
      });
      
      // Add event listener for remove device
      const removeBtn = deviceDiv.querySelector('.remove-device');
      removeBtn.addEventListener('click', () => {
        if (elements.devicesContainer.querySelectorAll('.device').length > 1) {
          deviceDiv.remove();
          elements.numDevices.value = parseInt(elements.numDevices.value) - 1;
        } else {
          showError('You must have at least one device.');
        }
      });
    };

    // Show error message
    const showError = (message) => {
      elements.errorMessage.textContent = message;
      elements.errorDisplay.classList.remove('hidden');
      setTimeout(() => {
        elements.errorDisplay.classList.add('hidden');
      }, 5000);
    };

    // Update power factor marker position
    const updatePfMarker = (markerElement, pf) => {
      const position = pf * 100;
      markerElement.style.left = `${position}%`;
    };

// Create power triangle chart
const createPowerTriangleChart = (canvas, P, Q, S, phiDeg, title) => {
  const maxVal = Math.max(P, Q, S) * 1.2 || 1;
  const axisMax = Math.max(maxVal, 1);

  // Calculate arc radius and angle in radians
  const arcRadius = axisMax * 0.25;
  const phiRad = phiDeg * Math.PI / 180;

  return new Chart(canvas, {
    type: 'line',
    data: {
      datasets: [
        {
          label: `Real Power (P) = ${P.toFixed(2)} kW`,
          data: [{ x: 0, y: 0 }, { x: P, y: 0 }],
          borderColor: 'rgba(59, 130, 246, 1)',
          borderWidth: 3,
          pointRadius: 0
        },
        {
          label: `Reactive Power (Q) = ${Q.toFixed(2)} kVAr`,
          data: [{ x: P, y: 0 }, { x: P, y: Q }],
          borderColor: 'rgba(239, 68, 68, 1)',
          borderWidth: 3,
          pointRadius: 0
        },
        {
          label: `Apparent Power (S) = ${S.toFixed(2)} kVA`,
          data: [{ x: 0, y: 0 }, { x: P, y: Q }],
          borderColor: 'rgba(16, 185, 129, 1)',
          borderWidth: 3,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { 
          display: true, 
          text: title, 
          font: { size: 16, weight: 'bold' }, 
          color: 'rgba(107, 114, 128, 1)' 
        },
        legend: { 
          position: 'bottom',
          labels: {
            boxWidth: 12,
            padding: 20
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label;
            }
          }
        },
        annotation: {
          annotations: {
            powerAngle: {
              type: 'arc',
              xMin: 0,
              xMax: arcRadius * Math.cos(phiRad),
              yMin: 0,
              yMax: arcRadius * Math.sin(phiRad),
              borderColor: 'rgba(255, 193, 7, 0.8)',
              borderWidth: 2,
              angle: {
                start: 0,
                end: phiRad
              },
              label: {
                display: true,
                content: `φ = ${phiDeg.toFixed(1)}°`,
                position: 'center',
                color: 'rgba(255, 193, 7, 1)',
                font: { size: 12, weight: 'bold' }
              }
            }
          }
        }
      },
      scales: {
        x: { 
          type: 'linear',
          min: 0, 
          max: axisMax, 
          title: { 
            display: true, 
            text: 'Real Power (P) [kW]',
            color: 'rgba(107, 114, 128, 1)'
          },
          grid: {
            color: 'rgba(229, 231, 235, 1)'
          },
          ticks: {
            color: 'rgba(107, 114, 128, 1)'
          }
        },
        y: { 
          type: 'linear',
          min: 0, 
          max: axisMax, 
          title: { 
            display: true, 
            text: 'Reactive Power (Q) [kVAr]',
            color: 'rgba(107, 114, 128, 1)'
          },
          grid: {
            color: 'rgba(229, 231, 235, 1)'
          },
          ticks: {
            color: 'rgba(107, 114, 128, 1)'
          }
        }
      }
    }
  });
};
    // Calculate results
    const calculateResults = () => {
      try {
        const systemType = elements.systemType;
        const voltage = parseFloat(elements.voltage.value) || 0.23;
        const pfTarget = elements.pfCorrectionSelect.value === 'yes' ? parseFloat(elements.pfTarget.value) : null;
        const utilityRate = parseFloat(elements.utilityRate.value) || 0.12;
        const reactiveChargeRate = parseFloat(elements.reactiveRate.value) || 0.05;
        const operatingHours = parseFloat(elements.operatingHours.value) || 8;
        const operatingDays = parseInt(elements.operatingDays.value) || 30;
        
        let totalP_kW = 0, totalQ_kVAr = 0;
        const deviceResults = [];
        
        // Get all devices
        const devices = elements.devicesContainer.querySelectorAll('.device');
        
        devices.forEach((device, index) => {
          const equipmentType = device.querySelector('.equipment-type').value;
          const loadType = device.querySelector('.load-type').value;
          
          let P, pf, Q, S, I;
          
          if (loadType === 'S & pf') {
            S = parseFloat(device.querySelector('.s-value').value) || 0;
            pf = parseFloat(device.querySelector('.pf-value').value) || 0.9;
          } else if (loadType === 'P & pf') {
            P = parseFloat(device.querySelector('.p-value').value) || 0;
            pf = parseFloat(device.querySelector('.pf-value').value) || 0.9;
          } else if (loadType === 'P+jQ') {
            P = parseFloat(device.querySelector('.p-value').value) || 0;
            Q = parseFloat(device.querySelector('.q-value').value) || 0;
          } else if (loadType === 'P & I') {
            P = parseFloat(device.querySelector('.p-value').value) || 0;
            I = parseFloat(device.querySelector('.i-value').value) || 0;
          }
          
          const params = {
            P,
            pf,
            Q,
            S,
            I
          };
          
          const out = calculatePowerParameters(voltage, params, systemType);
          
          const P_kW = out.P / 1000;
          const Q_kVAr = out.Q / 1000;
          const S_kVA = out.S / 1000;
          
          totalP_kW += P_kW;
          totalQ_kVAr += Q_kVAr;
          
          deviceResults.push({
            equipmentType,
            P_kW,
            Q_kVAr,
            S_kVA,
            pf: out.pf,
            phiDeg: out.phiDeg,
            Z: out.Z,
            I: out.I
          });
        });
        
        const totalS_kVA = Math.sqrt(totalP_kW ** 2 + totalQ_kVAr ** 2);
        const totalPf = totalS_kVA > 0 ? totalP_kW / totalS_kVA : 1;
        
        const cost = {
          energyConsumption_kWh: totalP_kW * operatingHours * operatingDays,
          energyCost_USD: totalP_kW * operatingHours * operatingDays * utilityRate,
          reactiveEnergy_kVArh: totalQ_kVAr * operatingHours * operatingDays,
          reactiveCost_USD: totalQ_kVAr * operatingHours * operatingDays * reactiveChargeRate
        };
        
        const correction = calculateCorrection(
          totalP_kW, 
          totalQ_kVAr, 
          totalS_kVA, 
          totalPf, 
          pfTarget, 
          systemType, 
          voltage, 
          utilityRate, 
          reactiveChargeRate, 
          operatingHours, 
          operatingDays
        );
        
        // Update UI with results
        updateResultsUI(totalP_kW, totalQ_kVAr, totalS_kVA, totalPf, deviceResults, cost, correction);
        
      } catch (err) {
        showError(err.message || 'An error occurred during calculation.');
      }
    };

    // Update UI with results
    const updateResultsUI = (totalP_kW, totalQ_kVAr, totalS_kVA, totalPf, deviceResults, cost, correction) => {
      // Update summary
      elements.totalP.textContent = `${totalP_kW.toFixed(2)} kW`;
      elements.totalQ.textContent = `${totalQ_kVAr.toFixed(2)} kVAr`;
      elements.totalS.textContent = `${totalS_kVA.toFixed(2)} kVA`;
      elements.totalPf.textContent = totalPf.toFixed(3);
      updatePfMarker(elements.currentPfMarker, totalPf);
      
      // Calculate total current and impedance
      const voltage = parseFloat(elements.voltage.value) || 0.23;
      const V = voltage * 1000;
      let totalCurrent, totalZ;
      
      if (elements.systemType === 'Single') {
        totalCurrent = totalS_kVA * 1000 / V;
        totalZ = V**2 / (totalS_kVA * 1000);
      } else {
        totalCurrent = totalS_kVA * 1000 / (Math.sqrt(3) * V);
        totalZ = V**2 / (totalS_kVA * 1000);
      }
      
      elements.totalCurrent.textContent = `${totalCurrent.toFixed(2)} A`;
      elements.totalZ.textContent = `${totalZ.toFixed(2)} Ω`;
      
      // Update devices table
      elements.devicesResultsBody.innerHTML = '';
      deviceResults.forEach(device => {
        const row = document.createElement('tr');
        row.className = 'border';
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${device.equipmentType}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${device.P_kW.toFixed(2)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${device.Q_kVAr.toFixed(2)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${device.S_kVA.toFixed(2)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${device.pf.toFixed(3)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${device.I.toFixed(2)}</td>
        `;
        elements.devicesResultsBody.appendChild(row);
      });
      
      // Update economics
      elements.energyConsumption.textContent = `${cost.energyConsumption_kWh.toFixed(2)} kWh/month`;
      elements.energyCost.textContent = `$${cost.energyCost_USD.toFixed(2)}/month`;
      elements.reactiveEnergy.textContent = `${cost.reactiveEnergy_kVArh.toFixed(2)} kVArh/month`;
      elements.reactiveCost.textContent = `$${cost.reactiveCost_USD.toFixed(2)}/month`;
      
      // Update correction results if applicable
      if (correction) {
        elements.noCorrectionNeeded.classList.add('hidden');
        elements.correctionResults.classList.remove('hidden');
        
        elements.qcNeeded.textContent = `${correction.QcNeeded_kVAr.toFixed(2)} kVAr`;
        elements.xcOhm.textContent = `${correction.Xc_ohm.toFixed(2)} Ω`;
        elements.cTotal.textContent = `${correction.C_total_F.toExponential(3)} F`;
        elements.correctedPf.textContent = correction.correctedPf.toFixed(3);
        elements.correctedQ.textContent = `${correction.correctedQ_kVAr.toFixed(2)} kVAr`;
        elements.correctedS.textContent = `${correction.correctedS_kVA.toFixed(2)} kVA`;
        
        if (elements.systemType === 'Three') {
          elements.perPhaseContainer.classList.remove('hidden');
          elements.cPerPhase.textContent = `${correction.perPhase_F.toExponential(3)} F`;
        } else {
          elements.perPhaseContainer.classList.add('hidden');
        }
        
        // Update savings
        elements.savingsContainer.classList.remove('hidden');
        elements.noSavings.classList.add('hidden');
        elements.correctedReactiveCost.textContent = `$${correction.reactiveCost_after.toFixed(2)}/month`;
        elements.energySavings.textContent = `$${correction.energyLossSavings.toFixed(2)}/month`;
        elements.totalSavings.textContent = `$${correction.totalSavings.toFixed(2)}/month`;
        
        // Create before/after correction charts
        if (window.beforeCorrectionChart) window.beforeCorrectionChart.destroy();
        if (window.afterCorrectionChart) window.afterCorrectionChart.destroy();
        
        window.beforeCorrectionChart = createPowerTriangleChart(
          elements.beforeCorrectionChart,
          totalP_kW,
          totalQ_kVAr,
          totalS_kVA,
          pfToDeg(totalPf),
          'Before Correction'
        );
        
        window.afterCorrectionChart = createPowerTriangleChart(
          elements.afterCorrectionChart,
          totalP_kW,
          correction.correctedQ_kVAr,
          correction.correctedS_kVA,
          pfToDeg(correction.correctedPf),
          'After Correction'
        );
      } else {
        elements.correctionResults.classList.add('hidden');
        
        if (elements.pfCorrectionSelect.value === 'yes') {
          elements.noCorrectionNeeded.classList.remove('hidden');
        } else {
          elements.noCorrectionNeeded.classList.add('hidden');
        }
        
        elements.savingsContainer.classList.add('hidden');
        elements.noSavings.classList.remove('hidden');
      }
      
      // Create main power triangle chart
      if (window.powerTriangleChart) window.powerTriangleChart.destroy();
      window.powerTriangleChart = createPowerTriangleChart(
        elements.powerTriangleChart,
        totalP_kW,
        totalQ_kVAr,
        totalS_kVA,
        pfToDeg(totalPf),
        'Power Triangle Diagram'
      );
    };

    // Download CSV
    const downloadCSV = () => {
      // This would be implemented similarly to your original function
      // but adapted to work with the new UI structure
      alert('CSV download functionality would be implemented here');
    };

    // Run validation tests
    const runTests = () => {
      const tests = [];
      
      try {
        // Test 1: 1-φ, P & pf (P=10 kW, pf=0.8, V=0.23 kV)
        let r1 = calculatePowerParameters(0.23, { P: 10, pf: 0.8 }, 'Single');
        tests.push({
          name: 'T1 Single P&pf',
          pass: Math.abs(r1.S / 1000 - 12.5) < 0.1 && Math.abs(r1.Q / 1000 - 7.5) < 0.1 && Math.abs(r1.I - 54.35) < 0.5,
          details: { S_kVA: (r1.S/1000).toFixed(3), Q_kVAr: (r1.Q/1000).toFixed(3), I_A: r1.I.toFixed(2) }
        });
        
        // Test 2: 3-φ, P & pf (P=30 kW, pf=0.9, V_LL=0.4 kV)
        let r2 = calculatePowerParameters(0.4, { P: 30, pf: 0.9 }, 'Three');
        tests.push({
          name: 'T2 Three P&pf',
          pass: Math.abs(r2.S / 1000 - 33.333) < 0.2 && Math.abs(r2.Q / 1000 - 14.526) < 0.2 && Math.abs(r2.I - 48.1) < 0.5,
          details: { S_kVA: (r2.S/1000).toFixed(3), Q_kVAr: (r2.Q/1000).toFixed(3), I_A: r2.I.toFixed(2) }
        });
        
        // Test 3: 1-φ, P+jQ (P=5 kW, Q=6 kVAr, V=0.23 kV)
        let r3 = calculatePowerParameters(0.23, { P: 5, Q: 6 }, 'Single');
        tests.push({
          name: 'T3 Single P+jQ',
          pass: Math.abs(r3.S / 1000 - Math.sqrt(61)) < 0.1 && Math.abs(r3.pf - 5/Math.sqrt(61)) < 0.01,
          details: { S_kVA: (r3.S/1000).toFixed(3), pf: r3.pf.toFixed(3), I_A: r3.I.toFixed(2) }
        });
        
        // Test 4: 1-φ, P & I (P=5 kW, I=25 A, V=0.23 kV)
        let r4 = calculatePowerParameters(0.23, { P: 5, I: 25 }, 'Single');
        tests.push({
          name: 'T4 Single P&I',
          pass: Math.abs(r4.S / 1000 - 5.75) < 0.1 && Math.abs(r4.pf - 5000/5750) < 0.01,
          details: { S_kVA: (r4.S/1000).toFixed(3), pf: r4.pf.toFixed(3), Q_kVAr: (r4.Q/1000).toFixed(3) }
        });
        
        // Show test results
        let testResults = 'Validation Test Results:\n\n';
        tests.forEach(test => {
          testResults += `${test.name}: ${test.pass ? 'PASS' : 'FAIL'}\n`;
          testResults += `Details: ${JSON.stringify(test.details, null, 2)}\n\n`;
        });
        
        alert(testResults);
        
      } catch (e) {
        alert('Test error: ' + e.message);
      }
    };

    // Event Listeners
    elements.addDeviceBtn.addEventListener('click', () => {
      const currentCount = elements.devicesContainer.querySelectorAll('.device').length;
      addDevice(currentCount);
      elements.numDevices.value = currentCount + 1;
    });

    elements.numDevices.addEventListener('change', () => {
      const newCount = parseInt(elements.numDevices.value) || 1;
      const currentCount = elements.devicesContainer.querySelectorAll('.device').length;
      
      if (newCount > currentCount) {
        // Add devices
        for (let i = currentCount; i < newCount; i++) {
          addDevice(i);
        }
      } else if (newCount < currentCount) {
        // Remove devices (but keep at least one)
        if (newCount < 1) {
          elements.numDevices.value = 1;
          return;
        }
        
        const devices = elements.devicesContainer.querySelectorAll('.device');
        for (let i = devices.length - 1; i >= newCount; i--) {
          if (i > 0) { // Keep at least one device
            devices[i].remove();
          }
        }
      }
    });

    elements.pfCorrectionSelect.addEventListener('change', (e) => {
      if (e.target.value === 'yes') {
        elements.pfTargetContainer.classList.remove('hidden');
      } else {
        elements.pfTargetContainer.classList.add('hidden');
      }
    });

    elements.pfTarget.addEventListener('input', (e) => {
      const value = parseFloat(e.target.value);
      elements.pfTargetValue.textContent = value.toFixed(2);
      updatePfMarker(elements.pfTargetMarker, value);
    });

    elements.calculateBtn.addEventListener('click', calculateResults);
    elements.testBtn.addEventListener('click', runTests);
    elements.downloadCsv.addEventListener('click', downloadCSV);

    // System type buttons
    elements.singlePhaseBtn.addEventListener('click', () => {
      elements.systemType = 'Single';
      elements.singlePhaseBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
      elements.singlePhaseBtn.classList.remove('bg-blue-800', 'hover:bg-blue-900');
      elements.threePhaseBtn.classList.add('bg-blue-800', 'hover:bg-blue-900');
      elements.threePhaseBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    });

    elements.threePhaseBtn.addEventListener('click', () => {
      elements.systemType = 'Three';
      elements.threePhaseBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
      elements.threePhaseBtn.classList.remove('bg-blue-800', 'hover:bg-blue-900');
      elements.singlePhaseBtn.classList.add('bg-blue-800', 'hover:bg-blue-900');
      elements.singlePhaseBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    });

    // Tab switching
    elements.summaryTab.addEventListener('click', () => {
      elements.summaryContent.classList.remove('hidden');
      elements.devicesContent.classList.add('hidden');
      elements.correctionContent.classList.add('hidden');
      elements.economicsContent.classList.add('hidden');
      
      elements.summaryTab.classList.add('tab-active');
      elements.devicesTab.classList.remove('tab-active');
      elements.correctionTab.classList.remove('tab-active');
      elements.economicsTab.classList.remove('tab-active');
    });

    elements.devicesTab.addEventListener('click', () => {
      elements.summaryContent.classList.add('hidden');
      elements.devicesContent.classList.remove('hidden');
      elements.correctionContent.classList.add('hidden');
      elements.economicsContent.classList.add('hidden');
      
      elements.summaryTab.classList.remove('tab-active');
      elements.devicesTab.classList.add('tab-active');
      elements.correctionTab.classList.remove('tab-active');
      elements.economicsTab.classList.remove('tab-active');
    });

    elements.correctionTab.addEventListener('click', () => {
      elements.summaryContent.classList.add('hidden');
      elements.devicesContent.classList.add('hidden');
      elements.correctionContent.classList.remove('hidden');
      elements.economicsContent.classList.add('hidden');
      
      elements.summaryTab.classList.remove('tab-active');
      elements.devicesTab.classList.remove('tab-active');
      elements.correctionTab.classList.add('tab-active');
      elements.economicsTab.classList.remove('tab-active');
    });

    elements.economicsTab.addEventListener('click', () => {
      elements.summaryContent.classList.add('hidden');
      elements.devicesContent.classList.add('hidden');
      elements.correctionContent.classList.add('hidden');
      elements.economicsContent.classList.remove('hidden');
      
      elements.summaryTab.classList.remove('tab-active');
      elements.devicesTab.classList.remove('tab-active');
      elements.correctionTab.classList.remove('tab-active');
      elements.economicsTab.classList.add('tab-active');
    });

    // Initialize
    initializeDevices();
    elements.singlePhaseBtn.click(); // Set to single phase by default
    elements.pfTarget.dispatchEvent(new Event('input')); // Initialize PF target marker
  </script>
  <footer>
        <p>&copy; 2025 Solomon Ofori Manu. All rights reserved.</p>
    </footer>
</body>
</html>
